<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>픽셀 맵 테스트 - 마카롱팩토리</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🚗</text></svg>">
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
            color: white;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .test-controls {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        
        .test-controls button {
            background: #4A90E2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            margin: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .test-controls button:hover {
            background: #357ABD;
            transform: translateY(-1px);
        }
        
        .test-controls button.danger {
            background: #E74C3C;
        }
        
        .test-controls button.danger:hover {
            background: #C0392B;
        }
        
        .map-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
            text-align: center;
        }
        
        #pixiCanvas {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: #2C3E50;
        }
        
        .info {
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .area-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .area-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }
        
        .area-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin: 0 auto 5px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏢 픽셀 아트 사무실 맵 테스트</h1>
            <p>PixiJS를 사용한 10x10 타일 맵 렌더링 테스트</p>
        </div>
        
        <div class="test-controls">
            <h3>🎮 테스트 컨트롤</h3>
            <button onclick="createMap()">맵 생성</button>
            <button onclick="destroyMap()" class="danger">맵 제거</button>
            <button onclick="showMapInfo()">맵 정보</button>
            <button onclick="toggleFullscreen()">전체화면</button>
            
            <hr style="margin: 15px 0; border: none; border-top: 1px solid rgba(255,255,255,0.2);">
            
            <h3>👥 캐릭터 컨트롤</h3>
            <button onclick="createCharacters()">캐릭터 생성</button>
            <button onclick="removeCharacters()" class="danger">캐릭터 제거</button>
            <button onclick="showCharacterInfo()">캐릭터 정보</button>
            <button onclick="moveRandomCharacter()">랜덤 이동</button>
        </div>
        
        <div class="map-container">
            <h3>🗺️ 맵 렌더링 영역</h3>
            <div id="pixiContainer"></div>
        </div>
        
        <div class="info">
            <h3>📋 맵 정보</h3>
            <p><strong>크기:</strong> 10x10 타일 (320x320 픽셀)</p>
            <p><strong>타일 크기:</strong> 32x32 픽셀</p>
            <p><strong>구역:</strong> 4개 구역 (미팅룸, 카페테리아, 좌석A, 좌석B)</p>
            
            <div class="area-info">
                <div class="area-item">
                    <div class="area-color" style="background: #4A90E2;"></div>
                    <strong>미팅룸</strong><br>
                    <small>구역 1</small>
                </div>
                <div class="area-item">
                    <div class="area-color" style="background: #7ED321;"></div>
                    <strong>카페테리아</strong><br>
                    <small>구역 2</small>
                </div>
                <div class="area-item">
                    <div class="area-color" style="background: #F5A623;"></div>
                    <strong>좌석A</strong><br>
                    <small>구역 3</small>
                </div>
                <div class="area-item">
                    <div class="area-color" style="background: #BD10E0;"></div>
                    <strong>좌석B</strong><br>
                    <small>구역 4</small>
                </div>
            </div>
        </div>
    </div>

    <!-- PixiJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.3.2/pixi.min.js"></script>
    
    <!-- 픽셀 맵 모듈 -->
    <script src="js/pixel-map.js"></script>
    
    <!-- 캐릭터 시스템 -->
    <script src="js/character-system.js"></script>
    
    <script>
        // PixiJS 앱 초기화
        let app;
        
        function initPixiApp() {
            try {
                if (app) {
                    app.destroy(true);
                }
                
                // DOM 컨테이너 확인
                const container = document.getElementById('pixiContainer');
                if (!container) {
                    console.error('❌ pixiContainer를 찾을 수 없습니다');
                    return false;
                }
                
                // 기존 캔버스 제거
                const existingCanvas = container.querySelector('canvas');
                if (existingCanvas) {
                    existingCanvas.remove();
                }
                
                // 수동으로 캔버스 생성
                const canvas = document.createElement('canvas');
                canvas.width = 400;
                canvas.height = 400;
                canvas.style.border = '2px solid rgba(255, 255, 255, 0.3)';
                canvas.style.borderRadius = '8px';
                canvas.style.background = '#2C3E50';
                
                // DOM에 캔버스 추가
                container.appendChild(canvas);
                
                // PixiJS 앱 생성 (기존 캔버스 사용)
                app = new PIXI.Application({
                    view: canvas,
                    width: 400,
                    height: 400,
                    backgroundColor: 0x2C3E50,
                    antialias: false,
                    resolution: 1
                });
                
                // 전역 app 객체 설정
                window.app = app;
                
                console.log('🎮 PixiJS 앱 초기화 완료');
                return true;
                
            } catch (error) {
                console.error('❌ PixiJS 앱 초기화 실패:', error);
                return false;
            }
        }
        
        // 맵 생성
        async function createMap() {
            try {
                console.log('🏗️ 맵 생성 시작...');
                
                // PixiJS 앱 초기화
                if (!app) {
                    const initSuccess = initPixiApp();
                    if (!initSuccess) {
                        throw new Error('PixiJS 앱 초기화 실패');
                    }
                }
                
                // app 객체 확인
                if (!app || !app.stage) {
                    throw new Error('PixiJS 앱가 제대로 초기화되지 않았습니다');
                }
                
                // PixelMapManager 초기화
                if (!window.pixelMapManager) {
                    window.pixelMapManager = new PixelMapManager(app);
                    console.log('🗺️ PixelMapManager 초기화 완료');
                }
                
                // 맵 생성
                const mapContainer = await window.createOfficeMap();
                console.log('✅ 맵 생성 완료:', mapContainer);
                
                // 맵을 중앙에 배치
                if (mapContainer) {
                    const centerX = (app.screen.width - mapContainer.width) / 2;
                    const centerY = (app.screen.height - mapContainer.height) / 2;
                    mapContainer.position.set(centerX, centerY);
                    console.log('📍 맵 중앙 배치 완료:', centerX, centerY);
                }
                
                // 애니메이션 루프 시작
                startAnimationLoop();
                
            } catch (error) {
                console.error('❌ 맵 생성 실패:', error);
                alert('맵 생성에 실패했습니다: ' + error.message);
            }
        }
        
        // 맵 제거
        function destroyMap() {
            window.removeOfficeMap();
            console.log('🗑️ 맵 제거 완료');
        }
        
        // 맵 정보 표시
        function showMapInfo() {
            const info = window.getMapInfo();
            if (info) {
                console.log('📋 맵 정보:', info);
                alert(`맵 정보:\n- 크기: ${info.width}x${info.height}\n- 타일 크기: ${info.tileSize}x${info.tileSize}\n- 총 타일 수: ${info.totalTiles}\n- 구역 수: ${Object.keys(info.areas).length}`);
            } else {
                alert('맵이 생성되지 않았습니다.');
            }
        }
        
        // 전체화면 토글
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        // 캐릭터 생성
        async function createCharacters() {
            try {
                console.log('👥 캐릭터 생성 시작...');
                
                // PixiJS 앱 확인
                if (!app) {
                    throw new Error('PixiJS 앱이 초기화되지 않았습니다. 먼저 맵을 생성해주세요.');
                }
                
                // 캐릭터 매니저 초기화
                if (!window.characterManager) {
                    window.createCharacterManager(app);
                    console.log('👥 캐릭터 매니저 초기화 완료');
                }
                
                // 샘플 캐릭터들 생성
                await window.createSampleCharacters();
                console.log('✅ 캐릭터 생성 완료');
                
            } catch (error) {
                console.error('❌ 캐릭터 생성 실패:', error);
                alert('캐릭터 생성에 실패했습니다: ' + error.message);
            }
        }
        
        // 캐릭터 제거
        function removeCharacters() {
            if (window.characterManager) {
                window.characterManager.removeAllCharacters();
                console.log('🗑️ 캐릭터 제거 완료');
            } else {
                alert('캐릭터 매니저가 초기화되지 않았습니다.');
            }
        }
        
        // 캐릭터 정보 표시
        function showCharacterInfo() {
            const characters = window.getCharactersInfo();
            if (characters.length > 0) {
                console.log('👥 캐릭터 정보:', characters);
                const infoText = characters.map(char => 
                    `${char.name} (${char.description})\n- 위치: (${char.position.x}, ${char.position.y})\n- 이동중: ${char.isMoving ? '예' : '아니오'}`
                ).join('\n\n');
                alert(`캐릭터 정보 (${characters.length}명):\n\n${infoText}`);
            } else {
                alert('캐릭터가 생성되지 않았습니다.');
            }
        }
        
        // 랜덤 캐릭터 이동
        function moveRandomCharacter() {
            if (!window.characterManager || window.characterManager.characters.length === 0) {
                alert('캐릭터가 생성되지 않았습니다.');
                return;
            }
            
            const characters = window.characterManager.characters;
            const randomCharacter = characters[Math.floor(Math.random() * characters.length)];
            
            // 랜덤 위치 생성 (맵 내부)
            const randomX = Math.random() * 320;
            const randomY = Math.random() * 320;
            
            window.moveCharacter(randomCharacter, randomX, randomY);
            console.log(`🎲 랜덤 이동: ${randomCharacter.name} → (${randomX}, ${randomY})`);
        }
        
        // 애니메이션 루프 (캐릭터 이동용)
        function startAnimationLoop() {
            if (app && window.characterManager) {
                app.ticker.add(() => {
                    window.characterManager.update();
                });
                console.log('🔄 애니메이션 루프 시작');
            }
        }
        
        // 페이지 로드 시 초기화
        window.addEventListener('load', () => {
            console.log('🚀 픽셀 맵 테스트 페이지 로드 완료');
            
            // PixiJS 로드 확인
            if (typeof PIXI !== 'undefined') {
                console.log('✅ PixiJS 로드 확인됨');
                console.log('📦 PIXI 버전:', PIXI.VERSION);
                
                // DOM 요소 확인
                const container = document.getElementById('pixiContainer');
                if (container) {
                    console.log('✅ pixiContainer 요소 확인됨');
                } else {
                    console.error('❌ pixiContainer 요소를 찾을 수 없습니다');
                }
            } else {
                console.error('❌ PixiJS 로드 실패');
                alert('PixiJS 라이브러리 로드에 실패했습니다. 페이지를 새로고침해주세요.');
            }
        });
    </script>
</body>
</html> 